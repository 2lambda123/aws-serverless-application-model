{
 "Resources": {
  "SuperCoolAPI": {
   "Type": "AWS::AppSync::GraphQLApi",
   "Properties": {
    "Name": "PradsApi",
    "AuthenticationType": "AWS_IAM",
    "LogConfig": {
     "FieldLogLevel": "ALL",
     "CloudWatchLogsRoleArn": {
      "Fn::GetAtt": [
       "SuperCoolAPICloudWatchRole",
       "Arn"
      ]
     }
    }
   }
  },
  "SuperCoolAPISchema": {
   "Type": "AWS::AppSync::GraphQLSchema",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "SuperCoolAPI",
      "ApiId"
     ]
    },
    "Definition": "type Mutation {\n  signUp(input: Signup): User\n}\n\ntype Query {\n  getUser(id: ID!): User\n}\n\ninput Signup {\n  username: String!\n  email: String!\n}\n\ntype User {\n  id: ID!\n  username: String\n  email: AWSEmail\n}\n\nschema {\n  query: Query\n  mutation: Mutation\n}\n"
   }
  },
  "SuperCoolAPICloudWatchRole": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Version": "2012-10-17",
     "Statement": [
      {
       "Action": [
        "sts:AssumeRole"
       ],
       "Effect": "Allow",
       "Principal": {
        "Service": [
         "appsync.amazonaws.com"
        ]
       }
      }
     ]
    },
    "ManagedPolicyArns": [
     {
      "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSAppSyncPushToCloudWatchLogs"
     }
    ]
   }
  },
  "SuperCoolAPIvalidateEmail": {
   "Type": "AWS::AppSync::FunctionConfiguration",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "SuperCoolAPI",
      "ApiId"
     ]
    },
    "Code": "import { util } from '@aws-appsync/utils';\n\nexport function request(ctx) {\n  const { email, username } = ctx.stash.input;\n  const valid = util.matches(\n    '^[a-zA-Z0-9_.+-]+@(?:(?:[a-zA-Z0-9-]+.)?[a-zA-Z]+.)?(xmyvaliddomain).com',\n    email\n  );\n  if (!valid) {\n    util.error(`\"${email}\" is not a valid email.`);\n  }\n\n  return { payload: { email, username } };\n}\n\nexport function response(ctx) {\n  return ctx.result;\n}\n",
    "DataSourceName": {
     "Fn::GetAtt": [
      "SuperCoolAPINoneDataSource",
      "Name"
     ]
    },
    "Name": "validateEmail",
    "Runtime": {
     "Name": "APPSYNC_JS",
     "RuntimeVersion": "1.0.0"
    }
   }
  },
  "SuperCoolAPIsaveUser": {
   "Type": "AWS::AppSync::FunctionConfiguration",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "SuperCoolAPI",
      "ApiId"
     ]
    },
    "Code": "import { util } from '@aws-appsync/utils';\n\nexport function request(ctx) {\n  return { payload: ctx.prev.result }\n}\n\nexport function response(ctx) {\n  ctx.result.id = util.autoId();\n  return ctx.result;\n}\n",
    "DataSourceName": {
     "Fn::GetAtt": [
      "SuperCoolAPINoneDataSource",
      "Name"
     ]
    },
    "Name": "saveUser",
    "Runtime": {
     "Name": "APPSYNC_JS",
     "RuntimeVersion": "1.0.0"
    }
   }
  },
  "SuperCoolAPIsignUp": {
   "Type": "AWS::AppSync::Resolver",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "SuperCoolAPI",
      "ApiId"
     ]
    },
    "Code": "\nexport function request(ctx) {\n    ctx.stash.input = ctx.args.input\n    return {};\n}\n\nexport function response(ctx) {\n    return ctx.prev.result;\n}\n",
    "FieldName": "signUp",
    "Kind": "PIPELINE",
    "PipelineConfig": {
     "Functions": [
      {
       "Fn::GetAtt": [
        "SuperCoolAPIvalidateEmail",
        "FunctionId"
       ]
      },
      {
       "Fn::GetAtt": [
        "SuperCoolAPIsaveUser",
        "FunctionId"
       ]
      }
     ]
    },
    "Runtime": {
     "Name": "APPSYNC_JS",
     "RuntimeVersion": "1.0.0"
    },
    "TypeName": "Mutation"
   }
  },
  "SuperCoolAPINoneDataSource": {
   "Type": "AWS::AppSync::DataSource",
   "Properties": {
    "ApiId": {
     "Fn::GetAtt": [
      "SuperCoolAPI",
      "ApiId"
     ]
    },
    "Name": "SuperCoolAPINoneDataSource",
    "Type": "NONE"
   }
  }
 }
}