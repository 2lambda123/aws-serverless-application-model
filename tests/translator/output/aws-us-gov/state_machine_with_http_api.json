{
    "Resources": {
      "APIGatewayDeploymentMyStateMachineRole": {
        "Type": "AWS::IAM::Role", 
        "Properties": {
          "Policies": [
            {
              "PolicyName": "APIGatewayDeploymentMyStateMachineRoleStartExecutionPolicy", 
              "PolicyDocument": {
                "Statement": [
                  {
                    "Action": [
                      "states:StartExecution", 
                      "states:StartSyncExecution"
                    ], 
                    "Resource": {
                      "Ref": "MyStateMachine"
                    }, 
                    "Effect": "Allow"
                  }, 
                  {
                    "Action": "states:StopExecution", 
                    "Resource": [
                      {
                        "Fn::Sub": [
                          "arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:execution:${__Name__}:*", 
                          {
                            "__Name__": {
                              "Fn::GetAtt": [
                                "MyStateMachine", 
                                "Name"
                              ]
                            }
                          }
                        ]
                      }
                    ], 
                    "Effect": "Allow"
                  }
                ]
              }
            }
          ], 
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17", 
            "Statement": [
              {
                "Action": [
                  "sts:AssumeRole"
                ], 
                "Effect": "Allow", 
                "Principal": {
                  "Service": [
                    "apigateway.amazonaws.com"
                  ]
                }
              }
            ]
          }
        }
      }, 
      "MyStateMachine": {
        "Type": "AWS::StepFunctions::StateMachine", 
        "Properties": {
          "DefinitionSubstitutions": {
            "MyFunction": {
              "Fn::GetAtt": [
                "MyFunction", 
                "Arn"
              ]
            }
          }, 
          "RoleArn": {
            "Fn::GetAtt": [
              "MyStateMachineRole", 
              "Arn"
            ]
          }, 
          "DefinitionS3Location": {
            "Bucket": "bucket", 
            "Key": "key"
          }, 
          "Tags": [
            {
              "Value": "SAM", 
              "Key": "stateMachine:createdBy"
            }
          ]
        }
      }, 
      "APIGatewayDeployment": {
        "Type": "AWS::ApiGatewayV2::Api", 
        "Properties": {
          "Body": {
            "info": {
              "version": "1.0", 
              "title": {
                "Ref": "AWS::StackName"
              }
            }, 
            "paths": {
              "/inbound": {
                "post": {
                  "x-amazon-apigateway-integration": {
                    "requestParameters": {
                      "StateMachineArn": {
                        "Ref": "MyStateMachine"
                      }
                    }, 
                    "integrationSubtype": "StepFunctions-StartExecution", 
                    "connectionType": "INTERNET", 
                    "payloadFormatVersion": "1.0", 
                    "credentials": {
                      "Fn::GetAtt": [
                        "APIGatewayDeploymentMyStateMachineRole", 
                        "Arn"
                      ]
                    }, 
                    "type": "aws_proxy"
                  }, 
                  "responses": {
                    "default": {
                      "description": "Default response for Method=post Path=/inbound"
                    }
                  }
                }
              }
            }, 
            "openapi": "3.0.1", 
            "tags": [
              {
                "name": "httpapi:createdBy", 
                "x-amazon-apigateway-tag-value": "SAM"
              }
            ]
          }
        }
      }, 
      "APIGatewayDeploymentdevStage": {
        "Type": "AWS::ApiGatewayV2::Stage", 
        "Properties": {
          "ApiId": {
            "Ref": "APIGatewayDeployment"
          }, 
          "AutoDeploy": true, 
          "StageName": "dev", 
          "Tags": {
            "httpapi:createdBy": "SAM"
          }
        }
      }, 
      "MyStateMachineRole": {
        "Type": "AWS::IAM::Role", 
        "Properties": {
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17", 
            "Statement": [
              {
                "Action": [
                  "sts:AssumeRole"
                ], 
                "Effect": "Allow", 
                "Principal": {
                  "Service": [
                    "states.amazonaws.com"
                  ]
                }
              }
            ]
          }, 
          "ManagedPolicyArns": [], 
          "Policies": [
            {
              "PolicyName": "MyStateMachineRolePolicy0", 
              "PolicyDocument": {
                "Statement": [
                  {
                    "Action": [
                      "lambda:InvokeFunction"
                    ], 
                    "Resource": {
                      "Fn::Sub": [
                        "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${functionName}*", 
                        {
                          "functionName": {
                            "Ref": "MyFunction"
                          }
                        }
                      ]
                    }, 
                    "Effect": "Allow"
                  }
                ]
              }
            }
          ], 
          "Tags": [
            {
              "Value": "SAM", 
              "Key": "stateMachine:createdBy"
            }
          ]
        }
      }
    }
  }