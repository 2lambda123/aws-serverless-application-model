Resources:
  MinimalFunction:
    Type: 'AWS::Serverless::Function'
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      CodeUri: s3://sam-demo-bucket/hello.zip
      Handler: hello.handler
      Runtime: python2.7
      AutoPublishAlias: live
      DeploymentPreference:
        Enabled: True
        Type: Linear10PercentEvery1Minute
        Hooks:
          PreTraffic: !Ref MySanityTestFunction
          PostTraffic: !Ref MyValidationTestFunction
        Alarms:
          - !Ref MyCloudWatchAlarm
        TriggerConfigurations:
          - TriggerEvents:
              - DeploymentSuccess
              - DeploymentFailure
            TriggerName: TestTrigger
            TriggerTargetArn: !Ref MySNSTopic

  MySanityTestFunction:
    Type: 'AWS::Serverless::Function'
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      Handler: hello.handler
      Runtime: python2.7
      CodeUri: s3://my-bucket/mySanityTestFunction.zip
      DeploymentPreference:
        Enabled: False

  MyValidationTestFunction:
    Type: 'AWS::Serverless::Function'
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      Handler: hello.handler
      Runtime: python2.7
      CodeUri: s3://my-bucket/myValidationTestFunction.zip
      DeploymentPreference:
        Enabled: False

  MyCloudWatchAlarm:
    Type: AWS::CloudWatch::Alarm
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
     ComparisonOperator: GreaterThanThreshold
     EvaluationPeriods: 1
     MetricName: MyMetric
     Namespace: AWS/EC2
     Period: 300
     Threshold: 10

  MySNSTopic:
    Type: AWS::SNS::Topic
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain